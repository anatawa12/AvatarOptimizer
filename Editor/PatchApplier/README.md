# Avatar Optimizer Patch System

This directory contains tools for applying temporary patches to Avatar Optimizer for testing fixes before they are officially released.

## Overview

The patch system allows users to test bug fixes and new features before they are included in official releases. Patches are designed to be:

- **Easy to apply** for users (via Unity UI)
- **Safe** with verification of file integrity before and after application
- **Traceable** with version information and patch metadata
- **Continuous** allowing patches to be stacked on top of each other

## For Users: Applying Patches

### Method 1: Unity Editor UI

1. Open your Unity project with Avatar Optimizer installed
2. Go to `Tools > Avatar Optimizer > Apply Patch`
3. Enter the patch URL or select a downloaded `.patch` file
   - Example URL: `https://github.com/anatawa12/AvatarOptimizer/commit/<hash>.patch`
4. Click "Apply Patch"
5. Wait for verification and application to complete

### Method 2: Manual Download

1. Download the `.patch` file from the GitHub commit or workflow artifacts
2. Open Unity and go to `Tools > Avatar Optimizer > Apply Patch`
3. Click "Browse" and select the downloaded file
4. Click "Apply Patch"

### Verifying Patch Application

After applying a patch, you can verify it was applied correctly:

1. Check the "Current Version Information" in the Patch Applier window
2. The version will show as `<base-version>+patch.<short-hash>`
3. Example: `1.9.0-rc.10+patch.abc123456`

### Important Notes

- **Patches are for testing only** and should not be used in production
- You can only apply patches that are based on your current version or the last applied patch
- Applied patches are recorded in `.patches.txt` (do not edit this file manually)
- Patch information is included in bug reports automatically

## For Developers: Generating Patches

### Using GitHub Actions (Recommended)

#### Manual Patch Generation

1. Go to Actions > "Generate Patch"
2. Click "Run workflow"
3. Fill in the parameters:
   - **Target**: Commit SHA, PR number, or commit range (e.g., `master...feature`)
   - **Base Version**: The release version to base the patch on (e.g., `1.9.0-rc.10`)
   - **Base Patch**: (Optional) If creating a continuous patch, the previous patch commit hash
   - **Custom Message**: (Optional) Additional information about the patch
4. Download the generated patch from the workflow artifacts

#### Automatic PR Patches

Patches are automatically generated for pull requests targeting `master`:

- Generated for both the latest stable and prerelease versions
- Posted as a comment on the PR
- Updated when the PR is updated
- Skipped if merge conflicts occur

### Using Local Script

For local changes or when you want to generate a patch from your development machine:

```bash
# From the repository root
./.github/scripts/generate-patch.sh \
  -t working \
  -v 1.9.0-rc.10 \
  -m "Testing fix for issue #123" \
  -o my-test-patch.patch
```

**Options:**
- `-t, --target`: `working` for current changes, commit SHA, or commit range (`base...head`)
- `-v, --base-version`: The base version (e.g., `1.9.0-rc.10`)
- `-p, --base-patch`: (Optional) Base patch commit for continuous patches
- `-m, --message`: (Optional) Custom message
- `-o, --output`: (Optional) Output file name

**Examples:**

```bash
# Generate patch from working directory changes
./generate-patch.sh -t working -v 1.9.0-rc.10 -m "Fix for material merging bug"

# Generate patch from a specific commit
./generate-patch.sh -t abc1234def -v 1.9.0-rc.10

# Generate patch from a commit range
./generate-patch.sh -t master...my-feature -v 1.9.0-rc.10

# Generate continuous patch (based on previous patch)
./generate-patch.sh -t def5678 -v 1.9.0-rc.10 -p abc1234
```

### Patch File Format

Patches use Git's standard `.patch` format with additional metadata in the commit message:

```
From <commit-hash> Mon Sep 17 00:00:00 2001
From: github-actions[bot] <...>
Date: ...
Subject: [PATCH] patch: <description>

<optional body>

Base-Version: 1.9.0-rc.10
Base-Commit: <base-commit-hash>
Base-Patch: <previous-patch-hash> (if continuous)
Pull-Request: <PR-URL> (if from PR)
Commit-Range: <range> (if from range)

Co-authored-by: <original-author>
---
 path/to/file1.cs | 10 +++++-----
 path/to/file2.cs |  5 +++--
 ...
```

### What Gets Excluded

The following files are automatically excluded from patches:
- Documentation files (`.docs/`, `CHANGELOG*.md`)
- Unity metadata and excluded files (`.` prefixed dirs/files, `~` suffixed dirs)

## Technical Details

### File Verification

The patch system verifies file integrity using Git blob SHA1 hashes:

1. Before applying: Verifies current files match the expected state
2. After applying: Verifies modified files match the expected new state
3. EOL normalization to LF is applied before hashing

### Patch Registry

Applied patches are stored in `.patches.txt` in YAML-like format:

```yaml
# Avatar Optimizer Applied Patches
- patch:
  commit: abc1234567890abcdef1234567890abcdef12
  base-version: 1.9.0-rc.10
  base-commit: def5678901234567890abcdef1234567890ab
  base-patch: xyz9876543210fedcba9876543210fedcba98
  pull-request: https://github.com/anatawa12/AvatarOptimizer/pull/123
  applied-at: 2024-02-10T12:34:56.789Z
```

### Version Display

When patches are applied, the version string is modified:
- **Display version**: `1.9.0-rc.10+patch.abc123456` (9-character short hash)
- **Full hash**: Available in bug reports and patch registry

## Troubleshooting

### "File SHA mismatch" error

This means the current file state doesn't match what the patch expects. Possible causes:
- Manual modifications to files
- Different version than specified
- Incompatible previous patch

**Solution**: Ensure you're on the correct base version or patch.

### "Cannot apply patch: it must be based on..." error

You're trying to apply a patch that doesn't follow from your current state.

**Solution**: Apply patches in order, or reset to the base version.

### Patch generation fails with conflicts

The changes conflict with the base version.

**Solution**: 
- Try a different base version
- Manually resolve conflicts before generating the patch
- Exclude conflicting documentation files (done automatically)

## Security Considerations

- **Patches modify package files** - only apply patches from trusted sources
- **SHA verification** prevents corrupted or tampered patches from being applied
- **Atomic application** - either all changes apply successfully or none do
- **Traceable** - all applied patches are logged with commit hashes

## Support

For issues with the patch system:
1. Check that you're using a supported version
2. Verify the patch URL or file is correct
3. Check Unity console for detailed error messages
4. Report issues with the patch system on GitHub
