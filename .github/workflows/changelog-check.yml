# this workflow checks CHANGELOG.md & CHANGELOG-SNAPSHOTS.md is updated correctly
# to skip this check, include `NO-CHANGELOG` for CHANGELOG.md
# and `NO-CHANGELOG-PRERELEASE` for CHANGELOG-PRERELEASE.md in tags of PR.
# also, this action ignores `dependencies` pull requests (expected to be generated by dependabot)

name: CHANGELOG check

on:
  pull_request:
    branches: [ master, master-* ]
    types: [ opened, synchronize, reopened, ready_for_review, labeled, unlabeled ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  releasenote-check:
    if: ${{ ! github.event.pull_request.draft }}
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - name: Changelog check
        env:
          GH_REPO: ${{ github.repositoryUrl }}
          GH_TOKEN: ${{secrets.GITHUB_TOKEN}}
          PR_NUM: ${{ github.event.number }}
        run: |
          json=$(mktemp)
          gh pr view $PR_NUM --json=files,labels > $json

          check_label() {
            jq -r '.labels[].name' < $json | grep -Fx "$1" > /dev/null || return 1
          }

          if check_label 'dependencies'; then
            # if there's dependencies tag, skip all checks
            echo "::notice ::check is suppressed by dependencies label"
            exit 0
          fi

          # list of error message.
          EXIT_CODE=0

          check_update() {
            FILE="$1"
            shift

            for LABEL in "$@"; do
              if check_label "$LABEL"; then
                echo "::notice ::check for $FILE is suppressed by $LABEL label"
                return 0
              fi
            done

            if ! jq -r '.files[].path' < $json | grep -Fx "$FILE"; then
              echo "::error ::$FILE is not updated!"
              EXIT_CODE=1
            fi
          }

          check_update CHANGELOG.md            documentation NO-CHANGELOG
          check_update CHANGELOG-PRERELEASE.md documentation NO-CHANGELOG-PRERELEASE

          exit $EXIT_CODE
