name: Auto Generate PR Patches

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - master
      - 'master-**'

permissions:
  contents: read
  pull-requests: write

jobs:
  generate-patches:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Generate patch for latest stable and prerelease
          - type: stable
          - type: prerelease
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest release version
        id: get_version
        run: |
          if [ "${{ matrix.type }}" = "stable" ]; then
            # Get latest non-prerelease tag
            VERSION=$(git tag -l 'v*' --sort=-version:refname | grep -v '-' | head -n1 | sed 's/^v//')
          else
            # Get latest prerelease tag
            VERSION=$(git tag -l 'v*' --sort=-version:refname | grep '-' | head -n1 | sed 's/^v//')
          fi
          
          if [ -z "$VERSION" ]; then
            echo "No ${{ matrix.type }} version found"
            echo "skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found ${{ matrix.type }} version: $VERSION"

      - name: Setup Git
        if: steps.get_version.outputs.skip != 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate patch using script
        if: steps.get_version.outputs.skip != 'true'
        id: generate
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          PR_HEAD="${{ github.event.pull_request.head.sha }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          OUTPUT_FILE="patch-${VERSION}.patch"
          
          # Run the script
          if ./.github/scripts/generate-patch.sh \
              -t "$PR_HEAD" \
              -v "$VERSION" \
              -m "From PR #${{ github.event.pull_request.number }}: $PR_TITLE" \
              -o "$OUTPUT_FILE"; then
            PATCH_COMMIT=$(git log -1 --format=%H 2>/dev/null || echo "unknown")
            echo "patch_commit=$PATCH_COMMIT" >> $GITHUB_OUTPUT
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload patch artifact
        if: steps.get_version.outputs.skip != 'true' && steps.generate.outputs.success == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: patch-${{ matrix.type }}-${{ steps.get_version.outputs.version }}
          path: patch-${{ steps.get_version.outputs.version }}.patch
          retention-days: 30

      - name: Post comment marker
        if: steps.get_version.outputs.skip != 'true'
        id: find_comment
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- patch-generation-comment-${{ matrix.type }} -->'

      - name: Create or update PR comment (success)
        if: steps.get_version.outputs.skip != 'true' && steps.generate.outputs.success == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            <!-- patch-generation-comment-${{ matrix.type }} -->
            ## :package: Test Patch for ${{ matrix.type }} version
            
            **Base Version:** `${{ steps.get_version.outputs.version }}` (${{ matrix.type }})
            **Status:** :white_check_mark: Success
            **Patch:** [Download](https://github.com/${{ github.repository }}/commit/${{ steps.generate.outputs.patch_commit }}.patch)
            
            ### How to Apply
            1. Open Unity with your project
            2. Go to `Tools > Avatar Optimizer > Apply Patch`
            3. Enter patch URL or download and select the file
            4. Click `Apply Patch`
            
            **Note:** Patches are for testing purposes only.

      - name: Create or update PR comment (failure)
        if: steps.get_version.outputs.skip != 'true' && steps.generate.outputs.success != 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          edit-mode: replace
          body: |
            <!-- patch-generation-comment-${{ matrix.type }} -->
            ## :package: Test Patch for ${{ matrix.type }} version
            
            **Base Version:** `${{ steps.get_version.outputs.version }}` (${{ matrix.type }})
            **Status:** :x: Failed - Could not generate patch (likely due to conflicts)
            
            Please check the workflow logs for details or try manually resolving conflicts.
